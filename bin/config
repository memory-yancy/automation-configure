#!/bin/bash

shopt -s dotglob

check_user_id()
{
    [[ $(id -u) = "0" ]] || {
        log_error "please use root privilege to run it again."
        return 1
    }
}

common_bashrc_config()
{
    log_info "config $HOME/.bashrc option files ..."

    grep -q "^#[[:space:]]*Below followings is generated by.*os-config-env" "$HOME/.bashrc" || {
        cat >> "${HOME}/.bashrc" <<-'EOF'
########################################################################
# Below followings is generated by os-config-env[https://github.com/uddmorningsun/os-env-config]
for file in ~/.{bash_prompt,bash_aliases,bash_functions,bash_exports}; do
    if [[ -r "$file" && -f "$file" ]]; then
        source "$file"
    fi
done
unset file
########################################################################
EOF
    }
}

common_user_config()
{
    log_info "config related option files ..."

    local all_dot_files="${OS_CONFIG_SRC}/dot-files"
    mkdir -p $HOME/{repo,dev-tools,PycharmProjects,rpmbuild}
    mkdir -p $HOME/{.mutt,.vscode}
    cp -rf $all_dot_files/* "$HOME"

    log_info "installing vim-plug"
    curl -s -fLo $HOME/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim || return
}

root_config_docker()
{
    log_info "config docker option files ..."

    mkdir -p /etc/docker || return
    cat > /etc/docker/daemon.json <<EOF
{
    "registry-mirrors": ["https://jxus37ad.mirror.aliyuncs.com"],
    "live-restore": true
}
EOF
}

ROLE="$1"
[[ "$ROLE" ]] || {
    log_error "role is required for $0"
    exit 1
}
[[ "$ROLE" = "root" || "$ROLE" = "normal" ]] || {
    log_error "role only support root or normal keyword"
    exit 1
}
if [[ "$ROLE" = "root" ]]; then
    check_user_id || exit
fi

common_bashrc_config || exit
common_user_config || exit
[[ "$ROLE" != "root" ]] || {
    root_config_docker || exit
}
